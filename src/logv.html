<html>

<head>
    <title>Logv</title>
    <script src="jquery.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="mark.js"></script>
    <script src="jquery.mark.js"></script>
    <link rel="stylesheet" href="jquery-ui.css">
    <style>
        * {
            box-sizing: content-box;
        }

        body {
            padding: 0px;
            margin: 0px;
            /* overflow: hidden; */
        }

        .tab-body {
            padding: 0px !important;
            height: 100%;
            width: 100%;
        }

        #tab-body-content-inner {
            padding: 0px;
            margin: 0px;
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto;
        }

        #container-content {
            padding: 0px;
            background: orange;
            grid-row: 1/2;
            grid-column: 1/2;
            height: 700px;
            overflow: hidden;
        }

        #container-slider {
            padding: 2px;
            padding-top: 15px;
            padding-bottom: 15px;
            grid-row: 1/2;
            grid-column: 2/3;
        }

        #content {
            background: darkgray;
        }

        #container-slider>#slider {
            height: 100%;
        }

        #container-body {
            display: grid;
            width: 100%;
            height: 100%;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto 1fr;
        }

        #menu-main {
            grid-column: 1/3;
            grid-row: 1/2;
        }

        #menu-main>li {
            width: 75px;
            float: left;
        }

        #panel-main {
            background: greenyellow;
            width: 250px;
            height: auto;
            grid-column: 1/2;
            grid-row: 2/3;
        }

        #tab-main {
            height: auto;
            padding: 0px;
            margin: 0px;
            background: coral;
            display: grid;
            grid-template-columns: auto;
            grid-template-rows: auto 1fr;
        }

        #tab-main-ul {
            padding: 0px;
        }

        .logline
        {
            padding: 0px;
            margin: 0px;
            white-space: pre;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div id="container-body">
        <ul id="menu-main">
            <li>
                <div>File</div>
                <ul>
                    <li>
                        <div id="menu-main-file-open">Open</div>
                    </li>
                    <li>
                        <div id="menu-main-file-close">Close</div>
                    </li>
                </ul>
            </li>
            <li>
                <div>Help</div>
            </li>
        </ul>

        <div id="panel-main"></div>
        <div id="tab-main">
            <ul id="tab-main-ul"></ul>
        </div>
    </div>

    <div id="dialog-open" title="File Open">
        <div>Specify path:</div>
        <input id="dialog-open-path" type="text" />
    </div>

    <div id="dialog-error" title="Error">
        <div id="dialog-error-text"></div>
    </div>

    <script>
        gLastLv = undefined;
        class Logv {
            constructor() {
                var self = this;
                self.scrolltimer = undefined;
                self.contentMouseDown = false;
                self.cachedLineCount = 50;
                self.lineHeight = 20;
                self.scroll = 0;
                self.scrollOffset = 0;
                self.cachedLines = [];
                self.marks = new Map;
                if (undefined == Logv.opened)
                {
                    Logv.opened = new Map;
                }
            }

            open(path) {
                var self = this;
                self.path = path;
                var openreq = $.get("/logv/open?path=" + path, function (resp) { self.onOpenRsp(resp) });
            }

            onOpenRsp(resp) {
                var self = this;
                // console.log("onOpen:", resp)
                var resp = JSON.parse(resp);

                if ("OK" != resp.status) {
                    $("#dialog-error-text").text("Status code: " + resp.status);
                    $("#dialog-error").dialog("open");
                    return;
                }

                self.tabref = "tab-main-div-" + resp.id;
                self.id = resp.id;
                Logv.opened.set(self.id, this);
                Logv.lastOpened = this;
                self.size = resp.size;
                
                $("#tab-main-ul").append("<li id='tab-main-ul-li-" + resp.id + "'><a href='#" + self.tabref + "'>" + self.path + "</a></li>");
                $("#tab-main").append("<div class='tab-body' id='" + self.tabref + "'><div id='tab-body-content-inner'></div></div>");
                $("#tab-main").tabs("refresh");
                
                self.tabref = "tab-main-div-" + resp.id + ">#tab-body-content-inner";
                // add content
                $("#" + self.tabref).append("<div style='position:relative' id='container-content'></div>");

                // add content slider
                $("#" + self.tabref).append("<div id='container-slider'></div>");
                $("#" + self.tabref + ">#container-slider").append("<div id='slider'></div>");

                $("#" + self.tabref + ">#container-content").on("mousedown", function () { self.contentMouseDown = true; });
                $("#" + self.tabref + ">#container-content").on("mousemove", function (event) {
                    if (false == self.contentMouseDown) {
                        return;
                    }
                    // console.log("content mouse drag");
                });
                $("#" + self.tabref + ">#container-content").on("mouseup", function () { self.contentMouseDown = false; });
                $('#' + self.tabref + ">#container-content").bind('mousewheel', function (e) {
                    if (e.originalEvent.wheelDelta / 120 > 0) {
                        self.scroll -= 1;
                    }
                    else {
                        self.scroll += 1;
                    }
                        self.updateScroll();
                });

                self.contentref = self.tabref + ">#container-content";
                self.slideref = self.tabref + ">#container-slider>#slider";

                $("#" + self.slideref).slider({
                    orientation: "vertical",
                    min: 0,
                    max: self.size,
                    value: self.size,
                    slide: function (event, ui) { self.onSlide(ui.value); }
                });

                self.sendGet(0, 0);
            }

            onGetRsp(resp) {
                var self = this;
                var resp = JSON.parse(resp);
                if (resp.content.length)
                {
                    var index = Math.floor(resp.content[0].line / self.cachedLineCount) % 3;
                    // console.log("onGetRsp updating self.cachedLines["+index+"]", resp);
                    self.cachedLines[index] = resp;
                    // TODO: update too slow
                    self.updateDisplay();
                }
            }

            onSlide(number)
            {
                var self = this;
                self.scroll = self.size - number;
                self.updateScroll();
            }

            updateScroll()
            {
                var self = this;

                if (self.scroll<0)
                {
                    self.scroll = 0;
                    return;
                }

                if ((self.scroll-self.scrollOffset)>=1000)
                {
                    self.scrollOffset = self.scroll;
                }
                else if ((self.scroll-self.scrollOffset)<0)
                {
                    self.scrollOffset = self.scroll;
                }

                if (undefined == self.scrolltimer)
                {
                    // console.log("updateScroll running scrolltimer timer!");
                    self.scrolltimer = window.setTimeout(function () {
                        self.scrolltimer = undefined;

                        var clc = self.cachedLineCount;
                        var lineCurrent = clc * Math.floor(self.scroll / clc);
                        var linePrev = clc * Math.floor((self.scroll - clc) / clc);
                        var lineNext = clc * Math.floor((self.scroll + clc) / clc);

                        var cacheIndexCurrent = Math.floor(self.scroll / clc) % 3;
                        var cacheIndexPrev = Math.floor((self.scroll - clc) / clc) % 3;
                        var cacheIndexNext = Math.floor((self.scroll + clc) / clc) % 3;

                        // console.log("updateScroll scrolltimer expiry", self.cachedLines);

                        var newUpdate = 0;
                        newUpdate += self.sendGet(cacheIndexCurrent, lineCurrent);
                        newUpdate += self.sendGet(cacheIndexNext, lineNext);
                        newUpdate += self.sendGet(cacheIndexPrev, linePrev);

                        if (0==newUpdate)
                        {
                            self.updateDisplay();
                        }
                    }, 100);
                }
            }

            sendGet(cacheIndex, line)
            {
                var self = this;
                var clc = self.cachedLineCount;
                if (line<0)
                {
                    if (cacheIndex<0)
                    {
                        cacheIndex = 3+cacheIndex;
                    }
                    // invalidate cache
                    //console.log("sendGet invalidate:", cacheIndex);
                    self.cachedLines[cacheIndex] = undefined;
                    return false;
                }
                if (undefined == self.cachedLines[cacheIndex] ||
                   line != self.cachedLines[cacheIndex].content[0].line)
                {
                    // console.log("sendGet GET /logv/get?id=" + self.id + "&line=" + line + "&size=" + clc);
                    $.get("/logv/get?id=" + self.id + "&line=" + line + "&size=" + clc, function (resp) { self.onGetRsp(resp) });
                    return true;
                }
                return false;
            }

            updateDisplay(forced)
            {
                var isForced = false;
                if (undefined != forced)
                {
                    isForced = forced;
                }
                var self = this;
                var clc = self.cachedLineCount;
                var currentCacheIndex = Math.floor(self.scroll / clc) % 3;
                var currentIndex = self.scroll % clc;

                var cachedCtr = [$("#" + self.contentref + ">#content-block-0")
                                ,$("#" + self.contentref + ">#content-block-1")
                                ,$("#" + self.contentref + ">#content-block-2")];

                var offset = self.scrollOffset;
                var i = 0;
                for (i=0; i<3; i++)
                {
                    if (true==isForced || 0==cachedCtr[i].length || undefined==self.cachedLines[i] || self.cachedLines[i].content[0].line != cachedCtr[i][0].dataset.line)
                    {
                        var cl = self.cachedLines[i];
                        if (0==cachedCtr[i].length)
                        {
                            // console.log("updateDisplay create display["+i+"]");
                            $("#" + self.contentref).append("<div style='position:absolute' id='content-block-"+i+"'><div>");
                            cachedCtr[i] = $("#" + self.contentref + ">#content-block-"+i);
                        }

                        if (undefined==cl)
                        {
                            // console.log("updateDisplay no cache cache["+i+"]");
                            if (0 != cachedCtr[i].length)
                            {
                                cachedCtr[i].html("");
                                // console.log("updateDisplay invalidate", cachedCtr[i]);
                            }
                            continue;
                        }

                        if (self.cachedLines[i].content[0].line != cachedCtr[i][0].dataset.line)
                        { // cached stale
                            // console.log("updateDisplay displaying: ",cl, "on", cachedCtr[i]);
                            // console.log("updateDisplay self.cachedLines[i].content[0].line: ", self.cachedLines[i].content[0].line);
                            // console.log("updateDisplay cachedCtr[i][0].dataset.line: ", cachedCtr[i][0].dataset.line);
                            cachedCtr[i].html("");
                            var j=0;
                            for (j=0; j<cl.content.length; j++)
                            {
                                var linenumber = document.createElement("span");
                                linenumber.style.display = "inline";
                                linenumber.innerText =  cl.content[j].original_line;

                                var string = document.createElement("span");
                                string.style.display = "inline";
                                string.style.marginLeft = "10px";
                                string.innerText = cl.content[j].string;

                                var logline = document.createElement("div");
                                logline.style.height = self.lineHeight + "px";
                                logline.className = "logline";

                                logline.appendChild(linenumber);
                                logline.appendChild(string);

                                cachedCtr[i][0].append(logline);
                            }
                            var line = (cl.content[0].line-offset);
                            cachedCtr[i][0].style.top = line*self.lineHeight +"px";
                            cachedCtr[i][0].dataset.line = cl.content[0].line;
                            // console.log("updateDisplay display:",i,"at top:",line*self.lineHeight);
                        }

                        // if (undefined == self.marktimer)
                        // {
                            var cachedCtrCurrent = cachedCtr[i];
                            // self.marktimer = window.setTimeout(function(){
                                self.marktimer = undefined;
                                self.marks.forEach(function(value,index){
                                    // console.log("marking",value,index,"on",cachedCtrCurrent);
                                    cachedCtrCurrent.markRegExp(value.regex, {className: "mark-"+index});
                                    var marked = $(".mark-"+index);
                                    marked.css("background",value.bgColor);
                                    marked.css("color",value.fgColor);
                                });
                            // }, 100);
                        // }
                    }
                }
                var scroll = self.scroll-offset;
                // console.log("updateDisplay actual scroll",self.scroll," scroll:", scroll,"scrollTop:",scroll*self.lineHeight);
                $("#" + self.contentref).scrollTop(scroll*self.lineHeight);
            }

            addMark(regex, markNumber, fgColor, bgColor)
            {
                self = this;
                self.marks.set(markNumber, {
                    regex: regex,
                    fgColor: fgColor,
                    bgColor: bgColor
                });
                self.updateDisplay(true);
            }

            removeMark(markNumber)
            {
                self.marks.delete(markNumber);
            }
        }

        $("#menu-main").menu();
        $("#menu-main-file-open").bind("click", function () {
            // console.log("click: #menu-main-file-open");
            $("#dialog-open").dialog("open");
        });
        $("#dialog-open").dialog({
            autoOpen: false,
            buttons: [
                {
                    text: "cancel",
                    // icon: "ui-icon-cancel",
                    click: function () { $(this).dialog("close"); }
                },
                {
                    text: "Ok",
                    // icon: "ui-icon-check",
                    click: function () {
                        var path = $("#dialog-open-path").val();
                        // console.log("open: path:", path);
                        var logv = new Logv();
                        logv.open(path);
                        $(this).dialog("close");
                    }
                }
            ]
        });
        $("#dialog-error").dialog({
            autoOpen: false,
            buttons: [
                {
                    text: "Ok",
                    // icon: "ui-icon-check",
                    click: function () {
                        $(this).dialog("close");
                    }
                }
            ]
        });
        $("#tab-main").tabs();

        var logv = new Logv();
    </script>
</body>

</html>