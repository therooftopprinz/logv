<html>

<head>
    <title>Logv</title>
    <script src="jquery.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="mark.js"></script>
    <script src="jquery.mark.js"></script>
    <link rel="stylesheet" href="jquery-ui.css">
    <style>
        * {
            box-sizing: content-box;
        }

        body {
            padding: 0px;
            margin: 0px;
            overflow: hidden;
        }

        #container-body {
            display: grid;
            width: 100%;
            height: 100%;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto 1fr;
        }

        #menu-main {
            grid-column: 1/3;
            grid-row: 1/2;
        }

        #menu-main>li {
            width: 75px;
            float: left;
        }

        #panel-main {
            background: greenyellow;
            width: 250px;
            height: auto;
            grid-column: 1/2;
            grid-row: 2/3;
        }

        #tab-main {
            height: auto;
            padding: 0px;
            margin: 0px;
            background: coral;
            display: grid;
            grid-template-columns: auto;
            grid-template-rows: auto 1fr;
        }

        #tab-main-ul {
            padding: 0px;
        }

        .logline
        {
            padding: 0px;
            margin: 0px;
            white-space: pre;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div id="container-body">
        <ul id="menu-main">
            <li>
                <div>File</div>
                <ul>
                    <li>
                        <div id="menu-main-file-open">Open</div>
                    </li>
                    <li>
                        <div id="menu-main-file-close">Close</div>
                    </li>
                </ul>
            </li>
            <li>
                <div>Help</div>
            </li>
        </ul>

        <div id="panel-main"></div>
        <div id="tab-main">
            <ul id="tab-main-ul"></ul>
        </div>
    </div>

    <div id="dialog-open" title="File Open">
        <div>Specify path:</div>
        <input id="dialog-open-path" type="text" />
    </div>

    <div id="dialog-error" title="Error">
        <div id="dialog-error-text"></div>
    </div>

    <script>
        gLastLv = undefined;

        class Viewer
            {
                constructor(element, size, contentCallback, displayUpdateCallback)
                {
                    var self = this;
                    var i;

                    self.logsize      = size;
                    self.pageLineSize = 25;
                    self.lineHeight   = 20;
                    self.scroll       = 0;
                    self.scrollx      = 0;
                    self.contentCallback = contentCallback;
                    self.displayUpdateCallback = displayUpdateCallback;
                    self.pageCount  = 6;
                    self.$ = jQuery; /* global jQuery */
                    self.element = self.$(element);
                    self.container = document.createElement("div");
                    self.container.style.display             = "grid";
                    self.container.style.gridTemplateColumns = "1fr auto";
                    self.container.style.gridTemplateRows    = "1fr auto";
                    self.container.style.height    = "100%";
                    self.container.style.width     = "100%";
                    self.container.style.padding   = "0px";
                    self.container.style.margin    = "0px";

                    self.element.html();
                    self.element[0].append(self.container);

                    self.content = document.createElement("div");
                    self.content.style.background = "brown";
                    self.content.style.height     = "100%";
                    self.content.style.position   = "relative";
                    self.content.style.overflow   = "hidden";
                    self.content.gridRow          = "1/2"
                    self.content.gridColumn       = "1/2"

                    // $(self.content).on("mousedown", function () {
                    //     console.log("content mouse down");
                    //     self.contentMouseDown = true;
                    // });
                    // $(self.content).on("mousemove", function (event) {
                    //     if (false == self.contentMouseDown) {
                    //         return;
                    //     }
                    //     console.log("content mouse drag");
                    // });
                    // $(self.content).on("mouseup", function () {
                    //     console.log("content mouse up");
                    //     self.contentMouseDown = false;
                    // });

                    $(self.content).bind('mousewheel', function (e) {
                        if (e.originalEvent.wheelDelta / 120 > 0)
                        {
                            self.onSlide(self.scroll-1);
                        }
                        else
                        {
                            self.onSlide(self.scroll+1);
                        }
                    });

                    self.contentPages  = new Array();
                    var pageColors = ["blue","green","red","cyan","yellow","magenta"];

                    for (i=0; i<self.pageCount; i++)
                    {
                        self.contentPages[i] = document.createElement("div")
                        self.contentPages[i].style.position   = "absolute";
                        self.contentPages[i].style.background = pageColors[i%pageColors.length];
                        self.content.append(self.contentPages[i]);
                    }

                    self.container.append(self.content);

                    var scrollerContainer = document.createElement("div");
                    scrollerContainer.style.background = "green";
                    scrollerContainer.style.height     = "100%";
                    scrollerContainer.style.display    = "flex";
                    scrollerContainer.style.alignItems      = "center";
                    scrollerContainer.style.justifyContent  = "center";
                    scrollerContainer.style.gridRow    = "1/2"
                    scrollerContainer.style.gridColumn = "2/3"

                    var scrollerContainer2 = document.createElement("div");
                    scrollerContainer2.style.background = "green";
                    scrollerContainer2.style.width     = "100%";
                    scrollerContainer2.style.display    = "flex";
                    scrollerContainer2.style.alignItems     = "center";
                    scrollerContainer2.style.justifyContent = "center";
                    scrollerContainer2.style.gridRow    = "2/3"
                    scrollerContainer2.style.gridColumn = "1/2"

                    self.scroller = document.createElement("div");
                    self.scroller.style.height        = "calc(100% - 40px)";
                    self.scroller.style.background    = "black";
                    self.scroller.style.border        = "0px";

                    self.scroller2 = document.createElement("div");
                    self.scroller2.style.width        = "calc(100% - 40px)";
                    self.scroller2.style.background   = "black";
                    self.scroller2.style.border       = "0px";

                    scrollerContainer.append(self.scroller);
                    scrollerContainer2.append(self.scroller2);
                    self.container.append(scrollerContainer);
                    self.container.append(scrollerContainer2);

                    self.createSlider();

                    self.onSlide(0);
                }

                fetch(offset, size, page)
                {
                    console.log("fetch", offset, size, page)
                    var self = this;
                    var reqcontext = {line:offset, page:page};
                    self.contentCallback(offset, size, reqcontext,
                    function(value, context){self.onData(value, context);});
                }

                setSize(size)
                {
                    var self = this;
                    self.size = size;
                    self.createSlider();
                }

                createSlider()
                {
                    var self = this;
                    self.$(self.scroller).slider({
                        orientation: "vertical",
                        min: 1,
                        max: self.logsize,
                        value: self.logsize,
                        slide: function (event, ui)
                        {
                            var value = self.logsize-ui.value;
                            self.onSlide(value);
                        }
                    });
                    self.$(self.scroller2).slider({
                        orientation: "horizontal",
                        min: 0,
                        max: 1000,
                        value: 0,
                        slide: function (event, ui)
                        {
                            self.scrollx = ui.value;
                            self.updateDisplay();
                        }
                    });
                }

                onSlide(value)
                {
                    var self = this;
                    if (value<0)
                    {
                        value=0;
                    }
                    else if (value>=(self.logsize-1))
                    {
                        value = self.logsize-1;
                    }
                    self.scroll = value;
                    self.container.dataset.scroll = value;
                    if (undefined != self.updateTimer)
                    {
                        return;
                    }

                    self.$(self.scroller).slider("value", self.logsize-self.scroll);

                    self.updateTimer = window.setTimeout(
                        function() {
                            self.updateTimer = undefined;
                            self.updateDisplay();
                        }, 100);
                }

                onData(value, context)
                {
                    var self = this;
                    var page = self.contentPages[context.page]
                    var i=0;

                    if (undefined == page.dataset.requestLine || page.dataset.requestLine != context.line)
                    {
                        return;
                    }

                    page.innerHTML = "";
                    page.dataset.line = context.line;

                    for(i=0; i<value.content.length; i++)
                    {
                        var gutter = document.createElement("span");
                        gutter.innerText = value.content[i].line + "  ";

                        var line = document.createElement("span");
                        line.innerText = value.content[i].string;

                        var log = document.createElement("div");
                        log.style.overflowY = "hidden";
                        log.style.height = self.lineHeight + "px";
                        log.className = "logline";
                        log.append(gutter);
                        log.append(line);

                        page.append(log)
                    }
                    
                    self.calculateMaxWidth();
                    self.displayUpdateCallback();
                }

                calculateMaxWidth()
                {
                    var self = this;
                    var maxWidth = 0;
                    var i;
                    for (i=0; i<self.pageCount; i++)
                    {
                        var currentPage = self.contentPages[i];
                        var width = parseFloat(window.getComputedStyle(currentPage).width);
                        console.log("calculateMaxWidth width:", window.getComputedStyle(currentPage).width);
                        if (width>maxWidth)
                        {
                            maxWidth = width;
                        }
                    }
                    self.maxWidth = maxWidth;
                    var contentWidth = parseFloat(window.getComputedStyle(self.content).width);
                    var width = self.maxWidth-contentWidth;

                    if (width>0)
                    {
                        self.$(self.scroller2).slider("option", "disabled", false);
                        self.$(self.scroller2).slider("option", "max", width);
                    }
                    else if(width<=0)
                    {
                        self.$(self.scroller2).slider("option", "disabled", true);
                        self.$(self.scroller2).slider("value", 0);
                        self.scrollx = 0;
                    }
                }

                updateDisplay()
                {
                    var self = this;
                    var i;
                    var pageNumber = Math.floor(self.scroll/self.pageLineSize);
                    var pageIndex = pageNumber%self.pageCount;
                    var pageHeight = self.pageLineSize*self.lineHeight;
                    var offset = (self.scroll%self.pageLineSize)*self.lineHeight;
                    // console.log("updateDisplay scroll:", self.scroll, "page:", pageNumber,"page-index:",pageIndex);
                    for (i=0; i<self.pageCount; i++)
                    {
                        var currentPage = self.contentPages[i];
                        var positionToCurrentPage = i-pageIndex;
                        var rawIndex = positionToCurrentPage%self.pageCount;
                        var index = rawIndex;

                        if (index<=(-self.pageCount/2))
                        {
                            index = self.pageCount + index;
                        }
                        else if (index > self.pageCount/2)
                        {
                            index =-(self.pageCount - index);
                        }

                        var currentLine = (pageNumber+index)*self.pageLineSize;

                        // console.log("E:", i, "data-line", currentLine, "index", index, "width:",width);
                        currentPage.style.top  = (index*pageHeight-offset)+"px";
                        currentPage.style.left = -self.scrollx+"px";

                        if (currentLine >= self.logsize || currentLine < 0)
                        {
                            currentPage.innerHTML = "end";
                            currentPage.dataset.requestLine = -1;
                            continue;
                        }

                        if (currentLine<=self.logsize && currentLine>=0 && ("end" == currentPage.innerHTML || undefined == currentPage.dataset.line || currentLine != currentPage.dataset.line))
                        {
                            currentPage.innerHTML = "loading...";
                            currentPage.dataset.requestLine = currentLine; 
                            self.fetch(currentLine, self.pageLineSize, i);
                        }
                    }

                    self.calculateMaxWidth();
                }
            }

        class Logv {
            constructor() {
                var self = this;
                self.scrolltimer = undefined;
                self.contentMouseDown = false;
                self.marks = new Map;

                if (undefined == Logv.opened)
                {
                    Logv.opened = new Map;
                }
            }

            open(path) {
                var self = this;
                self.path = path;
                var openreq = $.get("/logv/open?path=" + path, function (resp) { self.onOpenRsp(resp) });
            }

            onOpenRsp(resp) {
                var self = this;
                // console.log("onOpen:", resp)
                var resp = JSON.parse(resp);

                if ("OK" != resp.status)
                {
                    $("#dialog-error-text").text("Status code: " + resp.status);
                    $("#dialog-error").dialog("open");
                    return;
                }

                self.mainTabId = "tab-main-div-" + resp.id;
                self.id = resp.id;
                Logv.opened.set(self.id, this);
                Logv.lastOpened = this;
                self.size = resp.size;

                self.tab = document.createElement("li");
                var tablink =  document.createElement("a");
                tablink.href = "#" + self.mainTabId;
                tablink.innerText = self.path;
                self.tab.append(tablink);
                $(tablink).bind("click", function(){
                    self.onTabEnter();
                });
                self.tabMain = $("#tab-main");
                $("#tab-main-ul").append(self.tab);
                
                self.tabContent = document.createElement("div");
                self.tabContent.id = self.mainTabId;
                self.tabContent.style.padding = "0px";
                self.tabMain.append(self.tabContent);

                $("#tab-main").tabs("refresh");

                self.viewer = new Viewer(self.tabContent, self.size, function(offset, size, reqcontext, resultCallback) {
                    $.get("/logv/get?id=" + self.id + "&line=" + offset + "&size=" + size, function (resp) {
                        var resp = JSON.parse(resp);
                        if (resp.content.length)
                        {
                            resultCallback(resp, reqcontext);
                        }
                    });
                }, function() {
                    self.onViewUpdate();
                });
            }

            onTabEnter()
            {
                var self = this;
                self.viewer.updateDisplay();
            }

            onViewUpdate()
            {
                var self = this;
                self.marks.forEach(function(value,index){
                    $(self.tabContent).markRegExp(value.regex, {className: "mark-"+index});
                    var marked = $(".mark-"+index);
                    marked.css("background",value.bgColor);
                    marked.css("color",value.fgColor);
                });
            }
            addMark(regex, markNumber, fgColor, bgColor)
            {
                var self = this;
                self.marks.set(markNumber, {
                    regex: regex,
                    fgColor: fgColor,
                    bgColor: bgColor
                });
                self.onViewUpdate();
            }

            removeMark(markNumber)
            {
                var self = this;
                self.marks.delete(markNumber);
                self.onViewUpdate();
            }
        }

        $("#menu-main").menu();
        $("#menu-main-file-open").bind("click", function () {
            // console.log("click: #menu-main-file-open");
            $("#dialog-open").dialog("open");
        });
        $("#dialog-open").dialog({
            autoOpen: false,
            buttons: [
                {
                    text: "cancel",
                    // icon: "ui-icon-cancel",
                    click: function () { $(this).dialog("close"); }
                },
                {
                    text: "Ok",
                    // icon: "ui-icon-check",
                    click: function () {
                        var path = $("#dialog-open-path").val();
                        // console.log("open: path:", path);
                        var logv = new Logv();
                        logv.open(path);
                        $(this).dialog("close");
                    }
                }
            ]
        });
        $("#dialog-error").dialog({
            autoOpen: false,
            buttons: [
                {
                    text: "Ok",
                    // icon: "ui-icon-check",
                    click: function () {
                        $(this).dialog("close");
                    }
                }
            ]
        });
        $("#tab-main").tabs();

        var logv = new Logv();
        logv.open("test.log");
    </script>
</body>

</html>